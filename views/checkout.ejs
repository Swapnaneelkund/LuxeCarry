<!DOCTYPE html>
<html>
  <head>
    <title>Checkout</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      #card-element {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 4px;
        overflow-x: hidden; 
      }
    </style>
  </head>
  <body>
<div class="bg-gray-100 min-h-screen flex items-center justify-center">
      
<div class="bg-white p-8 rounded-lg shadow-md w-[90%] md:w-[60%] text-center flex flex-col gap-4">
  <h2 class="text-3xl mx-auto">Checkout</h2>
      <form id="payment-form" method="POST" class=" flex flex-col gap-4">
      <input type="hidden" id="amount" value="<%= amount %>" />

      <!-- Stripe Card Element -->
      <div id="card-element"></div>
      <button type="submit"  id="payBtn" class="text-2xl bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition duration-300 ease-in-out ">Pay <%= amount %></button>
    </form>
    <div id="payment-result"></div>
</div>
</div>

<script>
  const stripe = Stripe("<%= STRIPE_PUBLISHABLE_KEY %>");
  const elements = stripe.elements();
  const card = elements.create("card");
  card.mount("#card-element");

  const form = document.getElementById("payment-form");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const payBtn = document.querySelector("#payBtn");
    payBtn.disabled = true;
    payBtn.innerText = "Processing...";
    const amount = document.getElementById("amount").value;

    const res = await fetch("/payment", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ amount }),
    });

    const data = await res.json();

    if (!data.clientSecret) {
      document.getElementById("payment-result").innerText = "Failed to create payment intent.";
      return;
    }

    const result = await stripe.confirmCardPayment(data.clientSecret, {
      payment_method: {
        card: card,
      },
    });

    if (result.error) {
      document.getElementById("payment-result").innerText = result.error.message;
    } else if (result.paymentIntent.status === "succeeded") {
      document.getElementById("payment-result").innerText = "Payment successful!..you will be redirected to order within few seconds";
      setTimeout(() => {
      window.location.href = "/order";
      }, 5000);

    }
  });
</script>

  </body>
</html>
